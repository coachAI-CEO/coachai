import { GoogleGenerativeAI } from "@google/generative-ai";
import { generatePromptForReflection } from "./prompts";
import type { Reflection, SessionPlan } from "@/types/session";
import { randomUUID } from "crypto";

const GEMINI_MODEL = process.env.GEMINI_MODEL || "models/gemini-2.0-flash-lite";
const GEMINI_API_KEY = process.env.GEMINI_API_KEY!;

export async function generateReflection(session: SessionPlan): Promise<Reflection> {
  if (!GEMINI_API_KEY) throw new Error("Missing GEMINI_API_KEY");
  const genAI = new GoogleGenerativeAI(GEMINI_API_KEY);
  const model = genAI.getGenerativeModel({ model: GEMINI_MODEL });

  const prompt = generatePromptForReflection({ session });
  const resp = await model.generateContent({
    contents: [{ role: "user", parts: [{ text: prompt }] }],
  });

  const text = resp.response.text();
  let parsed: any;
  try {
    parsed = JSON.parse(text);
  } catch {
    throw new Error("AI did not return valid JSON");
  }

  const now = new Date().toISOString();
  const ref: Reflection = {
    id: randomUUID(),
    sessionId: session.id,
    summary: parsed.summary ?? "",
    whatWentWell: parsed.whatWentWell ?? [],
    toImproveNext: parsed.toImproveNext ?? [],
    focusForNextSession: parsed.focusForNextSession ?? [],
    psychNotes: parsed.psychNotes ?? [],
    timestamp: now,
  };
  return ref;
}
