import OpenAI from "openai";
import { GoogleGenerativeAI } from "@google/generative-ai";

function reqEnv(v: string | undefined, name: string) {
  if (!v) throw new Error(`Missing required env var: ${name}`);
  return v;
}

export async function runAI(provider: string, prompt: string): Promise<string> {
  if (!prompt?.trim()) throw new Error("No prompt provided");

  // --- GEMINI ---
  if (provider === "GEMINI") {
    const key = reqEnv(process.env.GEMINI_API_KEY, "GEMINI_API_KEY");
    const genAI = new GoogleGenerativeAI(key);
    const model = genAI.getGenerativeModel({ model: "models/gemini-2.0-flash-lite" });
    const result = await model.generateContent({
      contents: [{ role: "user", parts: [{ text: prompt }] }],
    });
    const text = result?.response?.text?.();
    if (!text) throw new Error("Empty response from Gemini");
    return text;
  }

  // --- OPENROUTER (Claude via fetch; do NOT use OpenAI SDK here) ---
  if (provider === "OPENROUTER") {
    const apiKey = reqEnv(process.env.OPENROUTER_API_KEY, "OPENROUTER_API_KEY");
    const baseURL = process.env.OPENROUTER_BASE_URL || "https://openrouter.ai/api/v1";
    const model = process.env.PLAN_MODEL || "anthropic/claude-3.5-sonnet";

    const res = await fetch(`${baseURL}/chat/completions`, {
      method: "POST",
      headers: {
        "Authorization": `Bearer ${apiKey}`,
        "Content-Type": "application/json",
        // OpenRouter requires BOTH of these:
        "HTTP-Referer": "http://localhost:3000",
        "X-Title": "CoachAI",
      },
      body: JSON.stringify({
        model,
        temperature: 0.3,
        messages: [{ role: "user", content: prompt }],
      }),
    });

    if (!res.ok) {
      const errText = await res.text().catch(() => "");
      throw new Error(`OpenRouter error ${res.status}: ${errText || res.statusText}`);
    }
    const data = await res.json();
    const text = data?.choices?.[0]?.message?.content;
    if (!text) throw new Error("OpenRouter empty response");
    return text;
  }

  // --- OPENAI (direct) ---
  if (provider === "OPENAI") {
    const client = new OpenAI({ apiKey: reqEnv(process.env.OPENAI_API_KEY, "OPENAI_API_KEY") });
    const res = await client.chat.completions.create({
      model: "gpt-4o-mini",
      messages: [{ role: "user", content: prompt }],
      temperature: 0.4,
    });
    return res.choices[0]?.message?.content || "";
  }

  throw new Error(`Unsupported provider: ${provider}`);
}
